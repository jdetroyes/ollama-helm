kind: pipeline
type: docker
name: test

trigger:
  event:
   - pull_request

steps:
  - name: lint chart
    image: alpine/helm
    commands:
      - helm lint

  - name: local render template chart
    image: alpine/helm
    commands:
      - helm template ollama-test . --debug

  - name: create kind cluster
    image: otwld/drone-kind
    settings:
      verbose: 1
      config: 'kind-config.yml'
      cluster_name: "helm-testing"
    volumes:
      - name: dockersock
        path: /var/run
      - name: kubeconfig
        path: /root/.kube
    depends_on:
      - docker-service

  - name: test chart
    image: quay.io/helmpack/chart-testing
    privileged: true
    commands:
      - sed -i -e "s/0.0.0.0/docker-service/g" $HOME/.kube/config
      - cat /root/.kube/config
      - kubectl cluster-info
      - ct install --chart-dirs . --charts .
    depends_on:
      - create kind cluster
    volumes:
      - name: kubeconfig
        path: /root/.kube

  - name: delete kind cluster
    image: otwld/drone-kind
    privileged: true
    settings:
      clean: true
    depends_on:
      - test chart
    volumes:
      - name: dockersock
        path: /var/run
      - name: kubeconfig
        path: /root/.kube



services:
  - name: docker-service
    image: docker:dind
    privileged: true
    volumes:
    - name: dockersock
      path: /var/run

volumes:
  - name: dockersock
    temp: {}
  - name: kubeconfig
    temp: {}

---
kind: pipeline
type: docker
name: publish


trigger:
  event:
  - promote
  branch:
   - main

steps:
  - name: publish helm chart to github pages
    image: otwld/drone-chart-releaser-github-pages
    settings:
      cr_token:
        from_secret: github_access_token
      skip_existing: true
      root_package: true